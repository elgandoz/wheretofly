<!DOCTYPE html>
<html>

<script src="common.js" type="text/javascript"></script>

<script language="javascript">

var data;
var locationTimeout;
var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
var sortBySite;
var showAllSites;
var showAllConditions;
var showTextForecast;

function applySiteFilters()
{
  var showAllSites = true;

  if(filters['sites'] && filters['sites'].length > 0)
    showAllSites = false;

  for(s in data.sites)
  {
    var site = data.sites[s];

    if(showAllSites || sitesFilter.indexOf(site.name) > -1)
      site.show = true;
  }
}

function onLoad()
{
  parseFilters();

  setView();

  getData(processData);

  document.getElementById("data").innerHTML = filters['data'];
}

function processData()
{
  applySiteFilters();

  if (navigator.geolocation)
  {
    locationTimeout = setTimeout("showForecast()", 4000);
    navigator.geolocation.getCurrentPosition(sortSites, showForecast, {timeout:3000});
  }
  else
    showForecast();
}

function sortSites(position)
{
  var pos = position.coords;

  clearTimeout(locationTimeout);
  
  for(s in data.sites)
  {
    var site = data.sites[s];

    site.dist = Math.pow(site.lat - pos.latitude, 2) + Math.pow(site.lon - pos.longitude, 2);
  }

  data.sites.sort(function(a, b){return a.dist-b.dist});
  
  showForecast();
}

function addTitleRow(forecastTable, title)
{
  var titleElement = document.createElement("tr");
  titleElement.setAttribute("bgcolor", "LightGrey");
    
  var element = document.createElement("td");
  element.innerHTML = title;
  titleElement.appendChild(element);

  var element = document.createElement("td");
  titleElement.appendChild(element);

  for(t in data.times)
  {
    element = document.createElement("td");
    element.innerHTML = data.times[t];
    titleElement.appendChild(element);
  }

  forecastTable.appendChild(titleElement);
}

function addRow(forecastTable, title, entry)
{
  var entryElement = document.createElement("tr");
        
  var titleElement = document.createElement("td");
  titleElement.innerHTML = title;
  entryElement.appendChild(titleElement);

  var forecastElement = document.createElement("td");
  if(entry.img)
  {
    if(showTextForecast)
    {
      forecastElement.innerHTML = entry.imgTitle;
    }
    else
    {
      var imageElement = document.createElement("img");
      imageElement.setAttribute("src", entry.img);
      imageElement.setAttribute("title", entry.imgTitle);
      imageElement.setAttribute("height", "25");
      forecastElement.appendChild(imageElement);
    }
  }
  entryElement.appendChild(forecastElement);

  var wtf = false;

  for(c in entry.conditions)
  {
    var cond = entry.conditions[c];

    var condElement = document.createElement("td");

    var dirStr = cond.dir;
    var kts = cond.kts;
    var colour = cond.colour;

    if(colour)
    {
      condElement.setAttribute("bgcolor", colour);
      wtf = true;
    }
    
    condElement.innerHTML = dirStr+":"+kts;
    
    entryElement.appendChild(condElement);
  }
  
  if(showAllConditions || wtf)
    forecastTable.appendChild(entryElement);
}

function siteTitle(site)
{
  var title = "";
  
  if(site.url)
    title += '<a href="'+site.url+'">'+site.title+'</a>';
  else
    title += site.title;
  
  title += " ";
  
  var conditions = "";
  
  if(site.minDir && site.maxDir) conditions = site.minDir+"-"+site.maxDir+" ";
  
  conditions += site.minSpeed+"-"+site.maxSpeed+" kts";
    
  if(site.weather_url)
    title += '<a href="'+site.weather_url+'"><font color="ForestGreen">'+conditions+'</font></a>';
  else
    title += conditions;

  title += " ";

  if(site.obs_url)
    title += '<a href="'+site.obs_url+'"><font color="Red">Now</font></a>';

  return title;
}

function dateTitle(dateStr)
{
  
  return dateStr+" "+days[new Date(dateStr).getDay()];
}

function setView()
{
  sortBySite = (filters['sortbysite'] == "true");
  showAllSites = (filters['showallsites'] == "true");
  showAllConditions = (filters['showallconditions'] == "true");
  showTextForecast = (filters['showtextforecast'] == "true");

  document.getElementById("sortBySite").checked = sortBySite;
  document.getElementById("showAllSites").checked = showAllSites;
  document.getElementById("showAllConditions").checked = showAllConditions;
  document.getElementById("showTextForecast").checked = showTextForecast;
}

function showForecast()
{
  sortBySite = filters['sortbysite'] = document.getElementById("sortBySite").checked;
  showAllSites = filters['showallsites'] = document.getElementById("showAllSites").checked;
  showAllConditions = filters['showallconditions'] = document.getElementById("showAllConditions").checked;
  showTextForecast = filters['showtextforecast'] = document.getElementById("showTextForecast").checked;

  window.history.replaceState(null, "", "?"+getFilters());

  var forecastTable = document.getElementById("forecastTable");
  var range = document.createRange();
  range.selectNodeContents(forecastTable);
  range.deleteContents();

  if(sortBySite)
  {
    for(s in data.sites)
    {
      var site = data.sites[s];

      if(showAllSites || site.show)
      {
        addTitleRow(forecastTable, siteTitle(site));

        for(e in site.forecast)
        {
          var entry = site.forecast[e];

          addRow(forecastTable, dateTitle(entry.date), entry);
        }
      }
    }
  }
  else
  {
    for(e in data.sites[0].forecast)
    {
      var date = data.sites[0].forecast[e].date;
      
      addTitleRow(forecastTable, dateTitle(date));

      for(s in data.sites)
      {
        var site = data.sites[s];

        if(showAllSites || site.show)
        {
          for(e in site.forecast)
          {
            var entry = site.forecast[e];
            
            if(date == entry.date)
              addRow(forecastTable, siteTitle(site), entry);
          }
        }
      }
    }
  }
}

</script>

<head>
<title>Where To Fly</title>
</head>
<body onload="onLoad()">
<font face="Helvetica">
<div style="position: fixed; background-color: white; width:100%; top: 0px;">
<table>
<tr><td bgcolor="Yellow">Too Light</td><td bgcolor="LightGreen"><b>Where To Fly</b></td><td bgcolor="Orange">Too Strong</td>
<td>Email feedback to <a href="mailto:feedback@wheretofly.info?subject=WTF%20Feedback">Phil</a></td></tr>
</table>
<form>
<input type="checkbox" id="sortBySite"        onchange="showForecast()"/>Sort by site
<input type="checkbox" id="showAllSites"      onchange="showForecast()"/>Show all sites
<input type="checkbox" id="showAllConditions" onchange="showForecast()"/>Show all conditions
<input type="checkbox" id="showTextForecast"  onchange="showForecast()"/>Show forecast
<input type="button"   value="Filter Sites"   onclick="setFilters('wtf-filter-sites.html')"/>
</form>
Hover mouse over weather icon for forecast. Showing: <span id="data"></span> <a href="#" onclick="setFilters('wtf-history.html')">Forecast History</a>
</div>
<div>
<br>
<br>
<br>
<br>
<table id="forecastTable" cellspacing="0" border=1>
</table>
</div>
</font>
</body>
</html>
